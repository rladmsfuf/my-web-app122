<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì´ë¯¸ì§€ ë¹„ìœ¨ ë³€í™˜ + ì›Œí„°ë§ˆí¬</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container { 
      max-width: 1000px; 
      margin: 0 auto; 
      background: white; 
      border-radius: 12px; 
      padding: 30px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    h1 { 
      text-align: center; 
      color: #333; 
      margin-bottom: 30px; 
      font-size: 2rem;
    }
    .upload-section {
      border: 3px dashed #007bff;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      margin-bottom: 30px;
      background: #f8f9ff;
    }
    .ratio-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    .ratio-btn {
      padding: 12px 24px;
      border: 2px solid #007bff;
      background: white;
      color: #007bff;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .ratio-btn.active {
      background: #007bff;
      color: white;
    }
    .watermark-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    .watermark-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
      font-weight: 600;
    }
    .watermark-toggle input {
      width: 20px;
      height: 20px;
      accent-color: #007bff;
    }
    .watermark-options {
      display: block;
      padding-left: 32px;
    }
    .watermark-option {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 12px;
    }
    .watermark-option label {
      min-width: 80px;
      font-weight: 500;
    }
    .control-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: #007bff; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .status {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 500;
      color: #666;
    }
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .preview-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      background: white;
    }
    .preview-card h4 {
      margin-bottom: 10px;
      font-size: 0.9rem;
      color: #333;
    }
    .preview-canvas {
      max-width: 100%;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .download-btn {
      width: 100%;
      padding: 8px 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #fileInput { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ì´ë¯¸ì§€ ë¹„ìœ¨ ë³€í™˜ + ì›Œí„°ë§ˆí¬</h1>
    <div class="upload-section" onclick="document.getElementById('fileInput').click()">
      <input type="file" id="fileInput" accept="image/*" multiple>
      <h3>ğŸ“¸ ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ</h3>
      <p>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•´ì„œ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
      <p style="color: #666; font-size: 0.9rem;">ìµœëŒ€ 500ì¥ê¹Œì§€ ì§€ì›</p>
    </div>
    <div class="ratio-buttons">
      <button class="ratio-btn active" data-ratio="16:9">16:9 ì™€ì´ë“œ</button>
      <button class="ratio-btn" data-ratio="4:3">4:3 ì¼ë°˜</button>
      <button class="ratio-btn" data-ratio="1:1">1:1 ì •ì‚¬ê°</button>
      <button class="ratio-btn" data-ratio="3:4">3:4 ì„¸ë¡œ</button>
    </div>
    <div class="watermark-section">
      <div class="watermark-toggle">
        <input type="checkbox" id="watermarkEnabled" checked>
        <label for="watermarkEnabled">ì›Œí„°ë§ˆí¬ ì¶”ê°€ (Free Care ë¡œê³ )</label>
      </div>
    </div>
    <div class="control-buttons">
      <button class="btn btn-primary" id="processBtn" disabled>ğŸš€ ì´ë¯¸ì§€ ì²˜ë¦¬</button>
      <button class="btn btn-secondary" id="clearBtn">ğŸ—‘ ì´ˆê¸°í™”</button>
      <button class="btn btn-success" id="zipBtn" disabled>ğŸ“¦ ZIP ë‹¤ìš´ë¡œë“œ</button>
    </div>
    <div class="status" id="status">ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
    <div class="preview-grid" id="previewGrid"></div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    // ì „ì—­ ë³€ìˆ˜
    let selectedFiles = [];
    let processedImages = [];
    let selectedRatio = '16:9';
    // DOM ìš”ì†Œë“¤
    const fileInput = document.getElementById('fileInput');
    const uploadSection = document.querySelector('.upload-section');
    const ratioButtons = document.querySelectorAll('.ratio-btn');
    const watermarkEnabled = document.getElementById('watermarkEnabled');
    const processBtn = document.getElementById('processBtn');
    const clearBtn = document.getElementById('clearBtn');
    const zipBtn = document.getElementById('zipBtn');
    const status = document.getElementById('status');
    const previewGrid = document.getElementById('previewGrid');

    // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ (alert ëŒ€ì‹  ì‚¬ìš©)
    function showMessage(msg) {
        status.textContent = msg;
        setTimeout(updateStatus, 5000); // 5ì´ˆ í›„ ì›ë˜ ìƒíƒœë¡œ ëŒì•„ê°
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
    fileInput.addEventListener('change', handleFileSelect);
    uploadSection.addEventListener('dragover', handleDragOver);
    uploadSection.addEventListener('drop', handleDrop);
    processBtn.addEventListener('click', processImages);
    clearBtn.addEventListener('click', clearAll);
    zipBtn.addEventListener('click', downloadZip);
    // ë¹„ìœ¨ ë²„íŠ¼ ì´ë²¤íŠ¸
    ratioButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        ratioButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedRatio = btn.dataset.ratio;
      });
    });
    // í•¨ìˆ˜ë“¤
    function handleFileSelect(e) {
      const files = Array.from(e.target.files);
      processFileSelection(files);
    }
    function handleDragOver(e) {
      e.preventDefault();
      uploadSection.style.background = '#e3f2fd';
    }
    function handleDrop(e) {
      e.preventDefault();
      uploadSection.style.background = '#f8f9ff';
      const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
      processFileSelection(files);
    }
    function processFileSelection(files) {
      if (files.length > 500) {
        showMessage('ìµœëŒ€ 500ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        selectedFiles = files.slice(0, 500);
      } else {
        selectedFiles = files;
      }
      updateStatus();
      showOriginalPreviews();
    }
    function updateStatus() {
      const fileCount = selectedFiles.length;
      const processedCount = processedImages.length;
      if (fileCount === 0) {
        status.textContent = 'ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”';
      } else if (processedCount === 0) {
        status.textContent = `${fileCount}ê°œ ì´ë¯¸ì§€ ì„ íƒë¨ - ì²˜ë¦¬ ëŒ€ê¸° ì¤‘`;
      } else {
        status.textContent = `${processedCount}ê°œ ì´ë¯¸ì§€ ì²˜ë¦¬ ì™„ë£Œ`;
      }
      processBtn.disabled = fileCount === 0;
      zipBtn.disabled = processedCount === 0;
    }
    function showOriginalPreviews() {
      previewGrid.innerHTML = '';
      selectedFiles.slice(0, 12).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            const card = document.createElement('div');
            card.className = 'preview-card';
            const title = document.createElement('h4');
            title.textContent = `${file.name} (ì›ë³¸)`;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const maxSize = 200;
            const scale = Math.min(maxSize / img.width, maxSize / img.height);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            canvas.className = 'preview-canvas';
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            card.appendChild(title);
            card.appendChild(canvas);
            previewGrid.appendChild(card);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }
    function getRatioValue(ratioStr) {
      const [w, h] = ratioStr.split(':').map(Number);
      return w / h;
    }
    function addWatermark(canvas, ctx) {
      if (!watermarkEnabled.checked) return;
      // 'Free'ì™€ 'Care' ë‘ ì¤„ë¡œ ì›Œí„°ë§ˆí¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
      const line1 = 'Free';
      const line2 = 'Care';
      const opacity = 1;
      
      // ê¸€ì í¬ê¸°ë¥¼ ì´ë¯¸ì§€ ë„ˆë¹„ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ì„¤ì •
      const fontSize = Math.min(canvas.width, canvas.height) * 0.04;
      ctx.font = `bold ${fontSize}px Arial`;

      // í…ìŠ¤íŠ¸ ì¸¡ì •
      const textMetrics1 = ctx.measureText(line1);
      const textMetrics2 = ctx.measureText(line2);
      const maxWidth = Math.max(textMetrics1.width, textMetrics2.width);
      
      const margin = 3; // ì—¬ë°±ì„ ì¤„ì—¬ì„œ ì›Œí„°ë§ˆí¬ë¥¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™
      const padding = 10; // íŒ¨ë”©ì„ ëŠ˜ë ¤ì„œ ì›Œí„°ë§ˆí¬ í¬ê¸°ë¥¼ í‚¤ì›€
      const lineHeight = fontSize * 1.2; // ì¤„ ê°„ê²©
      
      // ì „ì²´ ì›Œí„°ë§ˆí¬ ì˜ì—­ì˜ í¬ê¸° ê³„ì‚°
      const bgWidth = maxWidth + padding * 2;
      const bgHeight = (lineHeight * 2) + padding * 2;
      
      // ìœ„ì¹˜ ê³„ì‚°
      const bgX = canvas.width - bgWidth - margin;
      const bgY = canvas.height - bgHeight - margin;
      
      ctx.save();
      ctx.globalAlpha = opacity;
      
      // ë°°ê²½ ì‚¬ê°í˜• ê·¸ë¦¬ê¸° (ì™„ì „ ë¶ˆíˆ¬ëª…í•œ ê²€ì€ìƒ‰)
      ctx.fillStyle = 'rgba(0, 0, 0, 1)';
      ctx.fillRect(bgX, bgY, bgWidth, bgHeight);
      
      // ê·¸ë¦¼ì íš¨ê³¼ ì¶”ê°€
      ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
      ctx.shadowOffsetX = 2;
      ctx.shadowOffsetY = 2;
      ctx.shadowBlur = 4;
      
      // í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (ì™¼ìª½ ì •ë ¬, í°ìƒ‰)
      ctx.fillStyle = 'white';
      ctx.textBaseline = 'top';
      ctx.fillText(line1, bgX + padding, bgY + padding);
      ctx.fillText(line2, bgX + padding, bgY + padding + lineHeight);

      ctx.restore();
    }
    function processImages() {
      if (selectedFiles.length === 0) return;
      processedImages = [];
      previewGrid.innerHTML = '';
      const targetRatio = getRatioValue(selectedRatio);
      let completed = 0;
      status.textContent = `ì²˜ë¦¬ ì¤‘... (0/${selectedFiles.length})`;
      selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            // ë¹„ìœ¨ì— ë§ê²Œ í¬ë¡­
            let w = img.width, h = img.height;
            let sw, sh, sx, sy;
            if (w / h > targetRatio) {
              sh = h;
              sw = h * targetRatio;
              sx = (w - sw) / 2;
              sy = 0;
            } else {
              sw = w;
              sh = w / targetRatio;
              sx = 0;
              sy = (h - sh) / 2;
            }
            const canvas = document.createElement('canvas');
            canvas.width = sw;
            canvas.height = sh;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, sx, sy, sw, sh, 0, 0, sw, sh);
            // ì›Œí„°ë§ˆí¬ ì¶”ê°€
            addWatermark(canvas, ctx);
            // ê²°ê³¼ ì €ì¥
            const dataURL = canvas.toDataURL('image/jpeg', 0.92);
            const fileName = `${file.name.split('.')[0]}_${selectedRatio.replace(':', 'x')}.jpg`;
            processedImages.push({ dataURL, fileName, canvas });
            // ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ ìƒì„±
            const card = document.createElement('div');
            card.className = 'preview-card';
            const title = document.createElement('h4');
            title.textContent = `${fileName}`;
            const previewCanvas = document.createElement('canvas');
            const previewCtx = previewCanvas.getContext('2d');
            const maxSize = 200;
            const scale = Math.min(maxSize / canvas.width, maxSize / canvas.height);
            previewCanvas.width = canvas.width * scale;
            previewCanvas.height = canvas.height * scale;
            previewCanvas.className = 'preview-canvas';
            previewCtx.drawImage(canvas, 0, 0, previewCanvas.width, previewCanvas.height);
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'download-btn';
            downloadBtn.textContent = 'ê°œë³„ ë‹¤ìš´ë¡œë“œ';
            downloadBtn.onclick = () => {
              const a = document.createElement('a');
              a.href = dataURL;
              a.download = fileName;
              a.click();
            };
            card.appendChild(title);
            card.appendChild(previewCanvas);
            card.appendChild(downloadBtn);
            previewGrid.appendChild(card);
            // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
            completed++;
            status.textContent = `ì²˜ë¦¬ ì¤‘... (${completed}/${selectedFiles.length})`;
            if (completed === selectedFiles.length) {
              updateStatus();
            }
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }
    function clearAll() {
      selectedFiles = [];
      processedImages = [];
      fileInput.value = '';
      previewGrid.innerHTML = '';
      updateStatus();
    }
    async function downloadZip() {
      if (processedImages.length === 0) {
        showMessage('ì²˜ë¦¬ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      try {
        status.textContent = 'ZIP íŒŒì¼ ìƒì„± ì¤‘...';
        const zip = new JSZip();
        const folder = zip.folder(`images_${selectedRatio.replace(':', 'x')}`);
        // ê° ì´ë¯¸ì§€ë¥¼ ZIPì— ì¶”ê°€
        for (let i = 0; i < processedImages.length; i++) {
          const img = processedImages[i];
          try {
            // Canvasë¥¼ Blobìœ¼ë¡œ ë³€í™˜
            const blob = await new Promise(resolve => {
              img.canvas.toBlob(resolve, 'image/jpeg', 0.92);
            });
            if (blob) {
              folder.file(img.fileName, blob);
            } else {
              // Blob ìƒì„± ì‹¤íŒ¨ ì‹œ DataURL ì‚¬ìš©
              const base64Data = img.dataURL.split(',')[1];
              folder.file(img.fileName, base64Data, { base64: true });
            }
          } catch (error) {
            console.error(`ì´ë¯¸ì§€ ${i} ì²˜ë¦¬ ì˜¤ë¥˜:`, error);
            // ì˜¤ë¥˜ê°€ ìˆì–´ë„ ê³„ì† ì§„í–‰
            const base64Data = img.dataURL.split(',')[1];
            folder.file(img.fileName, base64Data, { base64: true });
          }
        }
        const content = await zip.generateAsync({
           type: 'blob',
          compression: 'DEFLATE',
          compressionOptions: { level: 6 }
        });
        // ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
        const url = URL.createObjectURL(content);
        const a = document.createElement('a');
        a.href = url;
        a.download = `processed_images_${selectedRatio.replace(':', 'x')}_${processedImages.length}ì¥.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        status.textContent = `ZIP ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! (${processedImages.length}ì¥)`;
      } catch (error) {
        console.error('ZIP ìƒì„± ì˜¤ë¥˜:', error);
        showMessage(`ZIP ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        updateStatus();
      }
    }
    // ì´ˆê¸°í™”
    updateStatus();
  </script>
</body>
</html>
